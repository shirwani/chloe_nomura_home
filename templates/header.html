<div class="logo">
    <a href="{{ url_for('home') }}" class="logo-link">
        <img class="logo-icon" src="https://chloe-nomura-home.atl1.cdn.digitaloceanspaces.com/website-images/chloe_nomura_icon.jpg" alt="Chloe profile image"/>
        <span class="logo-text">Chloe Nomura Home Furnishing</span>
    </a>
</div>
<div class="top-nav">
    <div class="container top-nav-inner">
        <div class="top-nav-left">
            {% if request.endpoint == 'home' %}
            <span class="btn btn-link nav-link-disabled" aria-current="page">Home</span>
            {% else %}
            <a href="{{ url_for('home') }}" class="btn btn-link">Home</a>
            {% endif %}
            {% if request.endpoint == 'get_inventory' %}
            <span class="btn btn-link nav-link-disabled" aria-current="page">Inventory</span>
            {% else %}
            <a href="{{ url_for('get_inventory') }}" class="btn btn-link">Inventory</a>
            {% endif %}
            {% if request.endpoint == 'about' %}
            <span class="btn btn-link nav-link-disabled" aria-current="page">About</span>
            {% else %}
            <a href="{{ url_for('about') }}" class="btn btn-link">About</a>
            {% endif %}
            {% if request.endpoint == 'contact' %}
            <span class="btn btn-link nav-link-disabled" aria-current="page">Contact</span>
            {% else %}
            <a href="{{ url_for('contact') }}" class="btn btn-link">Contact</a>
            {% endif %}
            <form class="top-nav-search" method="get" action="{{ url_for('get_inventory') }}">
                <div class="input-group input-group-sm">
                    <input type="text"
                           class="form-control"
                           name="q"
                           placeholder="Search by name, description, item ID, or category..."
                           value="{{ request.args.get('q', '') }}">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="submit">
                            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                        </button>
                    </span>
                </div>
            </form>
        </div>
        <div class="top-nav-right">
            {% if not user_is_guest %}
            <a href="{{ url_for('view_cart') }}" class="btn btn-link nav-cart">
                <span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span>
                {% if cart_count %}
                <span class="cart-count">{{ cart_count }}</span>
                {% endif %}
            </a>
            {% endif %}
            {% if user_first_name %}
                <div class="btn-group nav-user-menu">
                    <button type="button"
                            class="btn btn-link dropdown-toggle"
                            data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="false">
                        <span class="glyphicon glyphicon-user" aria-hidden="true"></span>
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right">
                        <li>
                            <a href="{{ url_for('profile') }}">View Profile</a>
                        </li>
                        {% if user_is_admin %}
                        <li>
                            <a href="{{ url_for('admin_users') }}">Admin</a>
                        </li>
                        {% endif %}
                        <li role="separator" class="divider"></li>
                        <li>
                            <a href="{{ url_for('logout') }}">Logout</a>
                        </li>
                    </ul>
                </div>
            {% elif user_is_guest %}
            <a href="{{ url_for('login_overlay', next=request.full_path or request.path) }}" class="btn btn-link"><span class="glyphicon glyphicon-log-in"></span> Login</a>
            {% endif %}
        </div>
    </div>
</div>
{# Show the inline login dialog for anonymous users or when explicitly forced.
   On dedicated auth pages (login/signup/forgot/reset), only show it when
   force_login_overlay is True so that the navbar Login link can still open
   the dialog from those pages (e.g., from the signup page for guests). #}
{% set _auth_endpoints = ['login', 'signup', 'forgot_password', 'forgot_password_send_link', 'reset_password'] %}
{% if (not user_roles or force_login_overlay) and (force_login_overlay or request.endpoint not in _auth_endpoints) %}
<div class="login-overlay">
    <div class="login-modal">
        <h3 class="login-title">Welcome to Chloe Nomura Home</h3>
        <p class="login-subtitle">Please log in, sign up, or continue as guest. Guests can browse, but cannot purchase items.</p>
        {% if login_error %}
        <div class="alert alert-danger">
            {{ login_error }}
        </div>
        {% endif %}
        <form method="post" action="{{ url_for('login') }}" id="login-form">
            <input type="hidden" name="next" value="{{ request.path }}">

            <div id="login-mode">
                <div class="form-group">
                    <label for="login_email">Email Address</label>
                    <input type="email"
                           class="form-control"
                           id="login_email"
                           name="email"
                           required>
                </div>
                <div class="form-group">
                    <label for="login_password">Password</label>
                    <input type="password"
                           class="form-control"
                           id="login_password"
                           name="password">
                </div>
                <div class="login-actions">
                    <button type="submit" name="action" value="login" class="btn btn-primary">
                        <span class="glyphicon glyphicon-log-in"></span> Login
                    </button>
                    <a href="{{ url_for('signup') }}" class="btn btn-default">
                        <span class="glyphicon glyphicon-user"></span> Sign Up
                    </a>
                    <button type="submit"
                            name="action"
                            value="guest"
                            class="btn btn-link"
                            onclick="prepareGuestContinue()">
                        Continue as Guest
                    </button>
                </div>
                <div style="margin-top: 10px;">
                    <button type="button"
                            class="btn btn-link"
                            onclick="showForgotPasswordMode()">
                        Forgot password?
                    </button>
                </div>
            </div>

            <div id="forgot-password-mode" style="display: none;">
                <div class="form-group">
                    <label for="fp_email_inline">Email Address</label>
                    <input type="email"
                           class="form-control"
                           id="fp_email_inline"
                           name="reset_email">
                </div>
                <div class="login-actions">
                    <button type="submit"
                            class="btn btn-primary"
                            formaction="{{ url_for('forgot_password_send_link') }}"
                            formmethod="post">
                        Send Reset Password Link
                    </button>
                    <button type="submit"
                            name="action"
                            value="guest"
                            class="btn btn-link"
                            onclick="prepareGuestContinue()">
                        Continue as Guest
                    </button>
                </div>
                <div style="margin-top: 10px;">
                    <button type="button"
                            class="btn btn-link"
                            onclick="showLoginMode()">
                        Back to Login
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}
<script>
function prepareGuestContinue() {
  var email1 = document.getElementById('login_email');
  var email2 = document.getElementById('fp_email_inline');
  if (email1) {
    email1.removeAttribute('required');
  }
  if (email2) {
    email2.removeAttribute('required');
  }
}
function showForgotPasswordMode() {
  var login = document.getElementById('login-mode');
  var forgot = document.getElementById('forgot-password-mode');
  var email1 = document.getElementById('login_email');
  var email2 = document.getElementById('fp_email_inline');
  if (login && forgot) {
    login.style.display = 'none';
    forgot.style.display = 'block';
  }
  if (email1) {
    email1.removeAttribute('required');
  }
  if (email2) {
    email2.setAttribute('required', 'required');
  }
}
function showLoginMode() {
  var login = document.getElementById('login-mode');
  var forgot = document.getElementById('forgot-password-mode');
  var email1 = document.getElementById('login_email');
  var email2 = document.getElementById('fp_email_inline');
  if (login && forgot) {
    forgot.style.display = 'none';
    login.style.display = 'block';
  }
  if (email2) {
    email2.removeAttribute('required');
  }
  if (email1) {
    email1.setAttribute('required', 'required');
  }
}
</script>
{% if login_forgot_mode %}
<script>
  // When coming back from "Send Reset Password Link", reopen the forgot-password
  // view so the user sees the confirmation message alongside the email field.
  showForgotPasswordMode();
</script>
{% endif %}
